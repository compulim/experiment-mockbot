{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "157952469400050373"
    },
    "description": "Deploy a bot with web apps"
  },
  "parameters": {
    "builderIdentityId": {
      "type": "string"
    },
    "deploymentFamilyName": {
      "type": "string",
      "maxLength": 40,
      "metadata": {
        "description": "Family name of the deployment."
      }
    },
    "deployTime": {
      "type": "string",
      "defaultValue": "[utcNow()]"
    },
    "location": {
      "type": "string"
    },
    "botIdentityClientId": {
      "type": "string"
    },
    "botIdentityId": {
      "type": "string"
    },
    "botIdentityTenantId": {
      "type": "string"
    },
    "speechServicesRegion": {
      "type": "string",
      "defaultValue": ""
    },
    "speechServicesResourceId": {
      "type": "string",
      "defaultValue": ""
    },
    "dummyClientSecret": {
      "type": "securestring",
      "defaultValue": "[format('DUMMY-SECRET-{0}', newGuid())]"
    }
  },
  "resources": {
    "bot": {
      "type": "Microsoft.BotService/botServices",
      "apiVersion": "2022-09-15",
      "name": "[format('{0}-bot', parameters('deploymentFamilyName'))]",
      "kind": "azurebot",
      "location": "global",
      "properties": {
        "displayName": "[format('{0}-bot', parameters('deploymentFamilyName'))]",
        "endpoint": "https://dummy.localhost/api/messages",
        "isStreamingSupported": true,
        "msaAppId": "[parameters('botIdentityClientId')]",
        "msaAppMSIResourceId": "[parameters('botIdentityId')]",
        "msaAppTenantId": "[parameters('botIdentityTenantId')]",
        "msaAppType": "UserAssignedMSI"
      },
      "sku": {
        "name": "S1"
      }
    },
    "botDummyOAuthConnection": {
      "type": "Microsoft.BotService/botServices/connections",
      "apiVersion": "2022-09-15",
      "name": "[format('{0}/{1}', format('{0}-bot', parameters('deploymentFamilyName')), format('{0}-oauth', format('{0}-bot', parameters('deploymentFamilyName'))))]",
      "location": "global",
      "properties": {
        "clientId": "dummy",
        "clientSecret": "[parameters('dummyClientSecret')]",
        "id": "dummy",
        "name": "Dummy",
        "serviceProviderId": "d05eaacf-1593-4603-9c6c-d4d8fffa46cb"
      },
      "dependsOn": [
        "bot"
      ]
    },
    "botCreateDirectLineChannelScript": {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2023-08-01",
      "name": "[format('{0}-create-direct-line-channel-script', parameters('deploymentFamilyName'))]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', parameters('builderIdentityId'))]": {}
        }
      },
      "kind": "AzureCLI",
      "location": "[parameters('location')]",
      "properties": {
        "arguments": "[format('\\\"{0}-bot\\\" \\\"{1}\\\" \\\"Default Site ({2})\\\"', parameters('deploymentFamilyName'), resourceGroup().name, parameters('deployTime'))]",
        "azCliVersion": "2.61.0",
        "cleanupPreference": "Always",
        "forceUpdateTag": "[parameters('deployTime')]",
        "retentionInterval": "PT1H",
        "scriptContent": "      set -eo pipefail\n\n      BOT_NAME=$1\n      RESOURCE_GROUP_NAME=$2\n      SITE_NAME=$3\n\n      # \"create\" will remove all other sites.\n      az bot directline create \\\n        --name $BOT_NAME \\\n        --resource-group $RESOURCE_GROUP_NAME \\\n        --location global \\\n        --site-name \"$SITE_NAME\" \\\n        --trusted-origins https://compulim.github.io\n\n      az bot directline show \\\n        --name $BOT_NAME \\\n        --resource-group $RESOURCE_GROUP_NAME \\\n        --with-secrets \\\n        | jq '{ extensionKey1: .setting.extensionKey1, key: .setting.sites[0].key }' \\\n        | tee $AZ_SCRIPTS_OUTPUT_PATH\n    ",
        "timeout": "PT2M"
      }
    },
    "botDirectLineSpeechChannel": {
      "condition": "[not(equals(parameters('speechServicesResourceId'), ''))]",
      "type": "Microsoft.BotService/botServices/channels",
      "apiVersion": "2022-09-15",
      "name": "[format('{0}/{1}', format('{0}-bot', parameters('deploymentFamilyName')), 'DirectLineSpeechChannel')]",
      "location": "global",
      "properties": {
        "channelName": "DirectLineSpeechChannel",
        "properties": {
          "cognitiveServiceRegion": "[parameters('speechServicesRegion')]",
          "cognitiveServiceResourceId": "[parameters('speechServicesResourceId')]",
          "isEnabled": true
        }
      },
      "dependsOn": [
        "bot"
      ]
    },
    "botWebChatChannel": {
      "type": "Microsoft.BotService/botServices/channels",
      "apiVersion": "2022-09-15",
      "name": "[format('{0}/{1}', format('{0}-bot', parameters('deploymentFamilyName')), 'WebChatChannel')]",
      "properties": {
        "channelName": "WebChatChannel",
        "properties": {
          "sites": []
        }
      },
      "dependsOn": [
        "bot"
      ]
    },
    "appIdentity": {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-07-31-preview",
      "name": "[format('{0}-app-identity', parameters('deploymentFamilyName'))]",
      "location": "[parameters('location')]"
    },
    "appPlan": {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2023-12-01",
      "name": "[format('{0}-app-plan', parameters('deploymentFamilyName'))]",
      "location": "[parameters('location')]",
      "properties": {
        "zoneRedundant": false
      },
      "sku": {
        "family": "S",
        "name": "S1",
        "size": "S1",
        "tier": "Standard"
      }
    },
    "app": {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-12-01",
      "name": "[format('{0}-app', parameters('deploymentFamilyName'))]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('{0}-app-identity', parameters('deploymentFamilyName'))))]": {},
          "[format('{0}', parameters('botIdentityId'))]": {}
        }
      },
      "location": "[parameters('location')]",
      "properties": {
        "clientAffinityEnabled": false,
        "httpsOnly": true,
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('{0}-app-plan', parameters('deploymentFamilyName')))]",
        "siteConfig": {
          "alwaysOn": true,
          "appSettings": [
            {
              "name": "WEBSITE_NODE_DEFAULT_VERSION",
              "value": "~20"
            },
            {
              "name": "DIRECTLINE_EXTENSION_VERSION",
              "value": "latest"
            },
            {
              "name": "DirectLineExtensionKey",
              "value": "[reference('botCreateDirectLineChannelScript').outputs.extensionKey1]"
            },
            {
              "name": "MicrosoftAppId",
              "value": "[parameters('botIdentityClientId')]"
            },
            {
              "name": "MicrosoftAppTenantId",
              "value": "[parameters('botIdentityTenantId')]"
            },
            {
              "name": "MicrosoftAppType",
              "value": "UserAssignedMSI"
            },
            {
              "name": "OAUTH_CONNECTION_NAME",
              "value": "[format('{0}-oauth', format('{0}-bot', parameters('deploymentFamilyName')))]"
            },
            {
              "name": "WEBSITE_RUN_FROM_PACKAGE",
              "value": "1"
            }
          ],
          "ftpsState": "Disabled",
          "metadata": [
            {
              "name": "CURRENT_STACK",
              "value": "node"
            }
          ],
          "webSocketsEnabled": true
        }
      },
      "dependsOn": [
        "appIdentity",
        "appPlan",
        "botCreateDirectLineChannelScript",
        "botDummyOAuthConnection"
      ]
    },
    "botReconfigureScript": {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2023-08-01",
      "name": "[format('{0}-reconfigure-script', parameters('deploymentFamilyName'))]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', parameters('builderIdentityId'))]": {}
        }
      },
      "kind": "AzureCLI",
      "location": "[parameters('location')]",
      "properties": {
        "arguments": "[format('\\\"{0}\\\" \\\"{1}\\\" \\\"{2}\\\"', reference('app').defaultHostName, format('{0}-bot', parameters('deploymentFamilyName')), resourceGroup().name)]",
        "azCliVersion": "2.61.0",
        "cleanupPreference": "Always",
        "forceUpdateTag": "[parameters('deployTime')]",
        "retentionInterval": "PT1H",
        "scriptContent": "      set -eo pipefail\n\n      BOT_APP_NAME=$1\n      BOT_NAME=$2\n      RESOURCE_GROUP_NAME=$3\n\n      az bot update \\\n        --name $BOT_NAME \\\n        --resource-group $RESOURCE_GROUP_NAME \\\n        --endpoint https://$BOT_APP_NAME/api/messages\n    ",
        "timeout": "PT2M"
      },
      "dependsOn": [
        "app",
        "bot"
      ]
    }
  },
  "outputs": {
    "appDefaultHostName": {
      "type": "string",
      "value": "[reference('app').defaultHostName]"
    },
    "appName": {
      "type": "string",
      "value": "[format('{0}-app', parameters('deploymentFamilyName'))]"
    },
    "appURL": {
      "type": "string",
      "value": "[format('https://{0}/', reference('app').defaultHostName)]"
    },
    "botName": {
      "type": "string",
      "value": "[format('{0}-bot', parameters('deploymentFamilyName'))]"
    },
    "directLineSecret": {
      "type": "securestring",
      "value": "[reference('botCreateDirectLineChannelScript').outputs.key]"
    }
  }
}